# üõ†Ô∏è Dokumentacja Deweloperska - KoREKtor

## üèóÔ∏è Architektura Systemu

### Komponenty G≈Ç√≥wne

```plaintext
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ    Frontend     ‚îÇ    ‚îÇ    Backend      ‚îÇ    ‚îÇ   Baza Wiedzy   ‚îÇ
‚îÇ   (Gradio UI)   ‚îÇ‚óÑ‚îÄ‚îÄ‚ñ∫‚îÇ   (app.py)      ‚îÇ‚óÑ‚îÄ‚îÄ‚ñ∫‚îÇ     (PDFs)      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                ‚îÇ
                                ‚ñº
                       ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                       ‚îÇ   HR Assistant  ‚îÇ
                       ‚îÇ(hr_assistant.py)‚îÇ
                       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                ‚îÇ
                                ‚ñº
                       ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                       ‚îÇ  Vector Store   ‚îÇ
                       ‚îÇ     (FAISS)     ‚îÇ
                       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Architektura v2.1 (Zrefaktoryzowana)

```plaintext
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ    Frontend     ‚îÇ    ‚îÇ    Backend      ‚îÇ    ‚îÇ   Config        ‚îÇ
‚îÇ   (Gradio UI)   ‚îÇ‚óÑ‚îÄ‚îÄ‚ñ∫‚îÇ   (app.py)      ‚îÇ‚óÑ‚îÄ‚îÄ‚ñ∫‚îÇ  (config.py)    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                ‚îÇ
                                ‚ñº
                       ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                       ‚îÇ HRAssistantV2   ‚îÇ
                       ‚îÇ(hr_assistant_v2)‚îÇ
                       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                ‚îÇ
                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚ñº           ‚ñº           ‚ñº
            ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
            ‚îÇDocumentMgr   ‚îÇ ‚îÇVectorDB ‚îÇ ‚îÇConversation  ‚îÇ
            ‚îÇ(docs+URLs)   ‚îÇ ‚îÇ(FAISS)  ‚îÇ ‚îÇMemory        ‚îÇ
            ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```plaintext

## üìÇ Struktura Kodu - Migracja

### üöÄ Przewodnik Migracji v1 ‚Üí v2.1

### Korzy≈õci Nowej Architektury

#### üìà Metryki Poprawy

- **Redukcja z≈Ço≈ºono≈õci**: G≈Ç√≥wna klasa z 377 ‚Üí 250 linii (-34%)
- **Testowalno≈õƒá**: Z 0 ‚Üí 14 test√≥w jednostkowych
- **Separacja odpowiedzialno≈õci**: 1 monolityczna klasa ‚Üí 3 specjalizowane komponenty
- **Konfiguracja**: Rozproszona ‚Üí scentralizowana w jednym miejscu

#### üéØ Zalety Funkcjonalne

- **≈Åatwiejsze debugowanie**: Wyizolowane komponenty
- **Szybsze rozw√≥j**: Modu≈Çowa architektura
- **Lepsze testowanie**: Ka≈ºdy komponent osobno
- **Elastyczna konfiguracja**: Zmienne ≈õrodowiskowe

### Opcje Migracji

#### üîÑ Opcja 1: Stopniowa Migracja (Zalecana)

```python
# Krok 1: U≈ºyj v2 r√≥wnolegle
from hr_assistant import HRAssistant as HRAssistantV1
from hr_assistant_v2 import HRAssistantV2
from config import KorektorConfig

# Krok 2: Por√≥wnaj wyniki
config = KorektorConfig()
assistant_v1 = HRAssistantV1()
assistant_v2 = HRAssistantV2(config)

# Krok 3: Testuj identyczno≈õƒá odpowiedzi
question = "Jakie sƒÖ najlepsze praktyki zatrudniania?"
answer_v1 = assistant_v1.ask(question)
answer_v2 = assistant_v2.ask(question)

# Krok 4: Gdy zadowolony, prze≈ÇƒÖcz import
# from hr_assistant_v2 import HRAssistantV2 as HRAssistant
```plaintext

#### ‚ö° Opcja 2: Szybka Migracja

```python
# W app.py zastƒÖp:
# from hr_assistant import HRAssistant
# hr_assistant = HRAssistant()

# Na:
from hr_assistant_v2 import HRAssistantV2
from config import KorektorConfig

config = KorektorConfig.from_env()
hr_assistant = HRAssistantV2(config)
```plaintext

#### üß™ Opcja 3: A/B Testing

```python
# U≈ºyj zmiennej ≈õrodowiskowej
import os
if os.getenv("USE_HR_V2", "false").lower() == "true":
    from hr_assistant_v2 import HRAssistantV2
    from config import KorektorConfig
    config = KorektorConfig.from_env()
    hr_assistant = HRAssistantV2(config)
else:
    from hr_assistant import HRAssistant
    hr_assistant = HRAssistant()
   ```bash

### Konfiguracja przez Zmienne ≈örodowiskowe

```bash
# .env file (zmienne ≈õrodowiskowe)
OPENAI_API_KEY=tw√≥j_klucz_api_openai            # Klucz API OpenAI
KOREKTOR_PDF_DIRECTORY=./custom_pdfs
KOREKTOR_CHUNK_SIZE=1500
KOREKTOR_LLM_MODEL=gpt-4
KOREKTOR_EMBEDDING_MODEL=text-embedding-3-large
KOREKTOR_MAX_CHUNKS=8
KOREKTOR_TEMPERATURE=0.2
KOREKTOR_MAX_TOKENS=1000
```

```python
# Automatyczne za≈Çadowanie konfiguracji
config = KorektorConfig.from_env()
assistant = HRAssistantV2(config)
```

### Testowanie Migracji

#### Uruchomienie Test√≥w

```bash
# Testy jednostkowe nowej architektury
python -m pytest test_refactoring.py -v

# Przyk≈Çady u≈ºycia
python refactoring_examples.py

# Automatyczna migracja (opcjonalnie)
python migrate_to_v2.py
```

#### Weryfikacja Kompatybilno≈õci

```python
# Test identyczno≈õci API
from test_refactoring import TestIntegration
test = TestIntegration()
test.test_v2_maintains_v1_compatibility()  # Sprawdza kompatybilno≈õƒá API
```

---

## üìÇ Struktura Kodu - Szczeg√≥≈Çy

### `app.py` - G≈Ç√≥wna Aplikacja

```python
# G≈Ç√≥wne funkcje:
- initialize_hr_assistant()      # Inicjalizacja przy starcie
- analyze_job_ad()              # Analiza og≈Çosze≈Ñ
- ask_hr_assistant()            # Interface do HR Assistant
- _generate_report()            # Generowanie raport√≥w Word
```

### `hr_assistant.py` - Silnik AI

```python
class HRAssistant:
    # G≈Ç√≥wne metody:
    - __init__()                    # Inicjalizacja z bibliografiƒÖ
    - _load_bibliography()          # ≈Åadowanie bibliografia.csv
    - _load_and_process_documents() # Przetwarzanie PDFs
    - ask()                        # G≈Ç√≥wna metoda odpowiedzi
    - reload_knowledge_base()      # Rƒôczne prze≈Çadowanie
```

### `IntelligentPDFChunker` - Przetwarzanie PDF

```python
class IntelligentPDFChunker:
    - _extract_pdf_structure()     # Ekstrakcja z zachowaniem struktury
    - chunk_documents()            # Inteligentne dzielenie na fragmenty
    - _detect_structure_markers()  # Wykrywanie nag≈Ç√≥wk√≥w
```

### `config.py` - Centralna Konfiguracja

```python
@dataclass
class KorektorConfig:
    # Parametry konfiguracyjne:
    - pdf_directory: str = "pdfs"
    - chunk_size: int = 1000
    - llm_model: str = "gpt-4o-mini"
    - embedding_model: str = "text-embedding-3-small"
    
    # Metody:
    - from_env()                   # Konfiguracja ze zmiennych ≈õrodowiskowych
    - for_testing()               # Konfiguracja dla test√≥w
    - validate()                  # Walidacja parametr√≥w
```

### `document_manager.py` - ZarzƒÖdzanie Dokumentami

```python
class DocumentManager:
    # Odpowiedzialno≈õci:
    - load_pdf_documents()        # ≈Åadowanie i przetwarzanie PDF
    - load_url_documents()        # ≈Åadowanie tre≈õci z URLs
    - load_all_documents()        # Kombinacja PDF + URLs z chunkowaniem
    - has_changes()               # Wykrywanie zmian w plikach
    - _load_bibliography()        # ZarzƒÖdzanie opisami bibliograficznymi
```

### `hr_assistant_v2.py` - Zrefaktoryzowany Asystent

```python
class HRAssistantV2:
    # Ulepszona architektura:
    - __init__(config)            # Inicjalizacja z konfiguracjƒÖ
    - _initialize_knowledge_base() # Delegacja do DocumentManager
    - _format_sources()           # Wydzielone formatowanie ≈∫r√≥de≈Ç
    - ask()                       # G≈Ç√≥wna metoda (kompatybilna z v1)
    - reload_knowledge_base()     # Wykorzystuje DocumentManager
```

### `test_refactoring.py` - Testy Jednostkowe

```python
# Klasy testowe:
class TestKorektorConfig:         # Testy konfiguracji
class TestDocumentManager:       # Testy zarzƒÖdzania dokumentami  
class TestIntegration:           # Testy integracyjne

# 14 test√≥w obejmujƒÖcych:
- Walidacjƒô konfiguracji
- ZarzƒÖdzanie dokumentami
- Wykrywanie zmian w plikach
- Integracjƒô komponent√≥w
```

## üîß Kluczowe Mechanizmy

### 1. ≈Åadowanie Bibliografii

```python
def _load_bibliography(self) -> Dict[str, str]:
    """
    ≈Åaduje bibliografia.csv i mapuje nazwy plik√≥w na opisy.
    Format: opis;filename
    """
    df = pd.read_csv("bibliografia.csv", delimiter=';')
    return dict(zip(df['filename'], df['opis']))
```

### 2. Cache'owanie Dokument√≥w

```python
# Zmienne ≈õledzƒÖce stan plik√≥w PDF:
self._known_pdfs = set()      # Nazwy znanych plik√≥w
self._pdf_mtimes = {}         # Czasy modyfikacji plik√≥w

def _pdfs_changed(self) -> bool:
    """Sprawdza czy pliki PDF siƒô zmieni≈Çy"""
    # Por√≥wnuje current_mtimes z self._pdf_mtimes
```

### 3. Metadane Dokument√≥w

```python
doc.metadata = {
    "filename": "dokument.pdf",
    "bibliography": "Autor, Tytu≈Ç, Wydawca, 2024",  # NOWE!
    "page": 15,
    "section": "Rozdzia≈Ç 3",
    "chunk_id": 0
}
```

### 4. Formatowanie ≈πr√≥de≈Ç

```python
def ask_hr_assistant(question):
    # Nowy format ≈∫r√≥de≈Ç:
    source_text = f"{i}. {bibliography}"
    if page: source_text += f", str. {page}"
    if section: source_text += f" - _{section}_"
    # Usuniƒôto fragmenty tekstu (snippet)
```

## üìä Przep≈Çyw Danych

### 1. Inicjalizacja Systemu

```text
Start ‚Üí ≈Åadowanie bibliografia.csv ‚Üí Skanowanie PDFs ‚Üí 
Ekstrakcja tekstu ‚Üí Chunking ‚Üí Embeddings ‚Üí 
Tworzenie FAISS ‚Üí Ready
```

### 2. Zapytanie do Asystenta

```text
Pytanie ‚Üí Embedding ‚Üí Similarity Search ‚Üí 
Retrieval ‚Üí LLM (GPT-4o-mini) ‚Üí 
Format Answer + Sources ‚Üí Response
```

### 3. Analiza Og≈Çoszenia

```text
Tekst/Plik ‚Üí Ekstrakcja ‚Üí Walidacja ‚Üí 
Analiza LLM ‚Üí Przetwarzanie ‚Üí 
Generowanie Raport√≥w ‚Üí JSON Output
```

## üêõ Debugowanie

### Logi Systemu

```bash
# W≈ÇƒÖczenie log√≥w debug:
export PYTHONPATH=$PYTHONPATH:.
python -c "import logging; logging.basicConfig(level=logging.DEBUG)"
python app.py
```

### Typowe Problemy

1. **Brak OPENAI_API_KEY**

   ```text
   ValueError: Brak klucza OPENAI_API_KEY
   ```

   RozwiƒÖzanie: `export OPENAI_API_KEY="sk-..."`

2. **Brak pliku bibliografia.csv**

   ```text
   WARNING: Plik bibliografia.csv nie istnieje
   ```

   System bƒôdzie u≈ºywa≈Ç nazw plik√≥w jako fallback.

3. **B≈ÇƒÖd ≈Çadowania PDF**

   ```text
   ERROR: B≈ÇƒÖd podczas przetwarzania PDF
   ```

   Sprawd≈∫ format i uszkodzenia pliku PDF.

### Narzƒôdzia Diagnostyczne

```python
# W hr_assistant.py dostƒôpne komendy:
assistant.get_stats()          # Statystyki systemu
assistant.clear_memory()       # Wyczy≈õƒá pamiƒôƒá rozm√≥w
assistant.reload_knowledge_base()  # Rƒôczne prze≈Çadowanie
```

## üß™ Testowanie

### Unit Testy

```bash
# Uruchomienie test√≥w:
python -m pytest tests/

# Test konkretnej funkcji:
python -c "
from hr_assistant import HRAssistant
assistant = HRAssistant(api_key='test', pdf_directory='pdfs')
print(assistant.get_stats())
"
```

### Testy Integracyjne

```python
# Test pe≈Çnego pipeline'u:
response = assistant.ask('Test pytanie')
assert 'answer' in response
assert 'sources' in response
assert len(response['sources']) > 0
```

## üîí Bezpiecze≈Ñstwo

### Klucze API

- Nigdy nie commituj kluczy do repozytorium
- U≈ºywaj zmiennych ≈õrodowiskowych
- Rotuj klucze regularnie

### Walidacja Danych

```python
# Sprawdzanie typu pliku:
ALLOWED_EXTENSIONS = ['.pdf', '.docx']
if file_extension not in ALLOWED_EXTENSIONS:
    return error_response
```

## üìà Optymalizacja

### Wydajno≈õƒá

- Baza wiedzy ≈Çadowana raz przy starcie
- Cache'owanie przetworzonych dokument√≥w
- Efektywne chunking z zachowaniem kontekstu

### Pamiƒôƒá

- FAISS przechowuje embeddingi w RAM
- Chunki majƒÖ ograniczony rozmiar (1000 znak√≥w)
- Automatyczne zarzƒÖdzanie pamiƒôciƒÖ konwersacji (ostatnie 5 wiadomo≈õci)

### Monitoring

```python
# Sprawdzanie zu≈ºycia zasob√≥w:
stats = assistant.get_stats()
print(f"Dokumenty: {stats['total_documents']}")
print(f"Pliki PDF: {stats['pdf_files']}")
print(f"Pamiƒôƒá rozm√≥w: {stats['memory_messages']}")
```

## üöÄ Deployment

### Lokalne Uruchomienie

```bash
python app.py
```

Aplikacja jest uruchamiana w domy≈õlnym interfejsie Gradio. Jest w pe≈Çni funkcjonalny, poza tym ≈ºe raport jest wy≈õwietlany w formacie JSON, kt√≥ry mo≈ºe nie byƒá czytelny dla cz≈Çowieka. Zalecamy wykorzystaƒá endpointy Gradio do przygotowania w≈Çasnego interfejsu.

### Zmienne ≈örodowiskowe

```bash
OPENAI_API_KEY=sk-...          # Wymagane
GRADIO_SERVER_NAME=0.0.0.0     # Opcjonalne
GRADIO_SERVER_PORT=7860        # Opcjonalne
```
